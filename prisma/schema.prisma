// Solution for undefined enum: https://github.com/prisma/prisma/discussions/20575#discussioncomment-9204363

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN  @map("admin")
  MEMBER @map("member")
}

enum Color {
  GRAY   @map("gray")
  RED    @map("red")
  BLUE   @map("blue")
  GREEN  @map("green")
  YELLOW @map("yellow")
  ORANGE @map("orange")
}

enum PropertyType {
  TEXT        @map("text")
  SELECT      @map("select")
  MULTISELECT @map("multiselect")
  CHECKBOX    @map("checkbox")
  URL         @map("url")
  DATE        @map("date")
  NUMBER      @map("number")
  CREATED     @map("created")
  RELATION    @map("relation")
  BUNDLE      @map("bundle")
}

enum Aggregator {
  COUNT           @map("count")
  COUNT_EMPTY     @map("count_empty")
  COUNT_NOT_EMPTY @map("count_not_empty")
  SUM             @map("sum")
  AVG             @map("avg")
}

enum ViewType {
  LIST  @map("list")
  TABLE @map("table")
}

enum SortType {
  ASC  @map("asc")
  DESC @map("desc")
}

type Filter {
  id     String
  values String[]
}

type Sort {
  field String
  order SortType @default(ASC)
}

type ViewProperty {
  id        String  @db.ObjectId
  isVisible Boolean @default(true)
}

type Option {
  id    String  @default(uuid()) @map("_id")
  value String
  color Color   @default(GRAY)
  extra String?
}

type PropertyRef {
  id    String @map("_id")
  value String @default("")
}

model User {
  id                    String                 @id @default(auto()) @map("_id") @db.ObjectId
  name                  String
  email                 String                 @unique
  emailVerified         Boolean                @default(false)
  role                  Role                   @default(MEMBER)
  password              String
  recoveryCode          Bytes
  totpKey               Bytes?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  sessions              Session[]
  collections           Collection[]
  group                 Group[]
  emailVerication       EmailVerication[]
  passwordResetSessions PasswordResetSession[]
}

model EmailVerication {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  code      String
  userId    String   @db.ObjectId
  user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
  email     String   @unique
  expiresAt DateTime
}

model PasswordResetSession {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  code              String   @unique
  email             String   @unique
  token             String   @unique
  userId            String   @db.ObjectId
  user              User     @relation(references: [id], fields: [userId], onDelete: Cascade)
  expiresAt         DateTime
  emailVerified     Boolean  @default(false)
  twoFactorVerified Boolean  @default(false)
}

model Session {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  token             String   @unique
  userId            String   @db.ObjectId
  user              User     @relation(references: [id], fields: [userId], onDelete: Cascade)
  expiresAt         DateTime
  role              Role
  twoFactorVerified Boolean  @default(false)
}

model Group {
  id         String       @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  owner      User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId    String       @db.ObjectId
  collection Collection[]
}

model Collection {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  icon         String     @default("folder")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  isPinned     Boolean    @default(true)
  description  String     @default("")
  isDescHidden Boolean    @default(true)
  isTemplate   Boolean    @default(false)
  views        View[]
  properties   Property[]
  items        Item[]
  owner        User?      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId      String?    @db.ObjectId
  group        Group?     @relation(fields: [groupId], references: [id])
  groupId      String?    @db.ObjectId
}

model View {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  shortId      Int
  collection   Collection     @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String         @db.ObjectId
  name         String
  type         ViewType       @default(LIST)
  order        Int            @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  properties   ViewProperty[]
  filters      Filter[]
  sorts        Sort[]
  groupBy      String?

  @@unique([collectionId, shortId])
  @@index([collectionId, order])
}

model Property {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  collection        Collection   @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId      String       @db.ObjectId
  name              String
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  type              PropertyType @default(TEXT)
  order             Int          @default(0)
  options           Option[]
  aggregator        Aggregator?
  defaultValue      String?
  targetCollection  String? // RELATION AND BUNDLE only
  relatedProperty   String? // RELATION only
  intTargetProperty String? // BUMDLE only
  extTargetProperty String? // BUNDLE only
  calculate         Aggregator? // BUNDLE only

  @@index([collectionId, order])
}

model Item {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  collection   Collection    @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String        @db.ObjectId
  properties   PropertyRef[]
}
